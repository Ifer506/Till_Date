{"version":3,"names":["_t","cloneNode","identifier","helpers","deep","obj","path","value","parts","split","last","shift","length","arguments","e","message","permuteHelperAST","ast","metadata","bindingName","localBindings","getDependency","adjustAst","locals","dependencies","exportBindingAssignments","exportName","bindings","Set","add","name","paths","Object","entries","newName","has","ref","map","forEach","p","helperData","create","loadHelper","helper","assign","ReferenceError","code","minVersion","build","nodes","body","globals","getDependencies","keys","get","list","replace"],"sources":["../src/index.ts"],"sourcesContent":["import { cloneNode, identifier } from \"@babel/types\";\nimport type * as t from \"@babel/types\";\nimport helpers from \"./helpers-generated.ts\";\nimport type { HelperMetadata } from \"./helpers-generated.ts\";\n\ntype GetDependency = (name: string) => t.Expression;\n\nfunction deep(obj: any, path: string, value?: unknown) {\n  try {\n    const parts = path.split(\".\");\n    let last = parts.shift();\n    while (parts.length > 0) {\n      obj = obj[last];\n      last = parts.shift();\n    }\n    if (arguments.length > 2) {\n      obj[last] = value;\n    } else {\n      return obj[last];\n    }\n  } catch (e) {\n    e.message += ` (when accessing ${path})`;\n    throw e;\n  }\n}\n\ntype AdjustAst = (\n  ast: t.Program,\n  exportName: string,\n  mapExportBindingAssignments: (\n    map: (node: t.Expression) => t.Expression,\n  ) => void,\n) => void;\n\n/**\n * Given a helper AST and information about how it will be used, update the AST to match the usage.\n */\nfunction permuteHelperAST(\n  ast: t.Program,\n  metadata: HelperMetadata,\n  bindingName: string | undefined,\n  localBindings: string[] | undefined,\n  getDependency: GetDependency | undefined,\n  adjustAst: AdjustAst | undefined,\n) {\n  const { locals, dependencies, exportBindingAssignments, exportName } =\n    metadata;\n\n  const bindings = new Set(localBindings || []);\n  if (bindingName) bindings.add(bindingName);\n  for (const [name, paths] of Object.entries(locals)) {\n    let newName = name;\n    if (bindingName && name === exportName) {\n      newName = bindingName;\n    } else {\n      while (bindings.has(newName)) newName = \"_\" + newName;\n    }\n\n    if (newName !== name) {\n      for (const path of paths) {\n        deep(ast, path, identifier(newName));\n      }\n    }\n  }\n\n  for (const [name, paths] of Object.entries(dependencies)) {\n    const ref =\n      (typeof getDependency === \"function\" && getDependency(name)) ||\n      identifier(name);\n    for (const path of paths) {\n      deep(ast, path, cloneNode(ref));\n    }\n  }\n\n  adjustAst?.(ast, exportName, map => {\n    exportBindingAssignments.forEach(p => deep(ast, p, map(deep(ast, p))));\n  });\n}\n\ninterface HelperData {\n  build: (\n    getDependency: GetDependency | undefined,\n    bindingName: string | undefined,\n    localBindings: string[] | undefined,\n    adjustAst: AdjustAst | undefined,\n  ) => {\n    nodes: t.Program[\"body\"];\n    globals: string[];\n  };\n  minVersion: string;\n  getDependencies: () => string[];\n}\n\nconst helperData: Record<string, HelperData> = Object.create(null);\nfunction loadHelper(name: string) {\n  if (!helperData[name]) {\n    const helper = helpers[name];\n    if (!helper) {\n      throw Object.assign(new ReferenceError(`Unknown helper ${name}`), {\n        code: \"BABEL_HELPER_UNKNOWN\",\n        helper: name,\n      });\n    }\n\n    helperData[name] = {\n      minVersion: helper.minVersion,\n      build(getDependency, bindingName, localBindings, adjustAst) {\n        const ast = helper.ast();\n        permuteHelperAST(\n          ast,\n          helper.metadata,\n          bindingName,\n          localBindings,\n          getDependency,\n          adjustAst,\n        );\n\n        return {\n          nodes: ast.body,\n          globals: helper.metadata.globals,\n        };\n      },\n      getDependencies() {\n        return Object.keys(helper.metadata.dependencies);\n      },\n    };\n  }\n\n  return helperData[name];\n}\n\nexport function get(\n  name: string,\n  getDependency?: GetDependency,\n  bindingName?: string,\n  localBindings?: string[],\n  adjustAst?: AdjustAst,\n) {\n  if (!process.env.BABEL_8_BREAKING) {\n    // In older versions, bindingName was a t.Identifier | t.MemberExpression\n    if (typeof bindingName === \"object\") {\n      const id = bindingName as t.Identifier | t.MemberExpression | null;\n      if (id?.type === \"Identifier\") {\n        bindingName = id.name;\n      } else {\n        bindingName = undefined;\n      }\n    }\n  }\n  return loadHelper(name).build(\n    getDependency,\n    bindingName,\n    localBindings,\n    adjustAst,\n  );\n}\n\nexport function minVersion(name: string) {\n  return loadHelper(name).minVersion;\n}\n\nexport function getDependencies(name: string): ReadonlyArray<string> {\n  return loadHelper(name).getDependencies();\n}\n\nif (!process.env.BABEL_8_BREAKING && !USE_ESM) {\n  // eslint-disable-next-line no-restricted-globals\n  exports.ensure = (name: string) => {\n    loadHelper(name);\n  };\n}\n\nexport const list = Object.keys(helpers).map(name => name.replace(/^_/, \"\"));\n\nexport default get;\n"],"mappings":"AAAA,YAAAA,EAAA,MAAsC,cAAc;AAAC;EAA5CC,SAAS;EAAEC;AAAU,IAAAF,EAAA;AAE9B,OAAOG,OAAO,MAAM,wBAAwB;AAK5C,SAASC,IAAIA,CAACC,GAAQ,EAAEC,IAAY,EAAEC,KAAe,EAAE;EACrD,IAAI;IACF,MAAMC,KAAK,GAAGF,IAAI,CAACG,KAAK,CAAC,GAAG,CAAC;IAC7B,IAAIC,IAAI,GAAGF,KAAK,CAACG,KAAK,CAAC,CAAC;IACxB,OAAOH,KAAK,CAACI,MAAM,GAAG,CAAC,EAAE;MACvBP,GAAG,GAAGA,GAAG,CAACK,IAAI,CAAC;MACfA,IAAI,GAAGF,KAAK,CAACG,KAAK,CAAC,CAAC;IACtB;IACA,IAAIE,SAAS,CAACD,MAAM,GAAG,CAAC,EAAE;MACxBP,GAAG,CAACK,IAAI,CAAC,GAAGH,KAAK;IACnB,CAAC,MAAM;MACL,OAAOF,GAAG,CAACK,IAAI,CAAC;IAClB;EACF,CAAC,CAAC,OAAOI,CAAC,EAAE;IACVA,CAAC,CAACC,OAAO,IAAI,oBAAoBT,IAAI,GAAG;IACxC,MAAMQ,CAAC;EACT;AACF;AAaA,SAASE,gBAAgBA,CACvBC,GAAc,EACdC,QAAwB,EACxBC,WAA+B,EAC/BC,aAAmC,EACnCC,aAAwC,EACxCC,SAAgC,EAChC;EACA,MAAM;IAAEC,MAAM;IAAEC,YAAY;IAAEC,wBAAwB;IAAEC;EAAW,CAAC,GAClER,QAAQ;EAEV,MAAMS,QAAQ,GAAG,IAAIC,GAAG,CAACR,aAAa,IAAI,EAAE,CAAC;EAC7C,IAAID,WAAW,EAAEQ,QAAQ,CAACE,GAAG,CAACV,WAAW,CAAC;EAC1C,KAAK,MAAM,CAACW,IAAI,EAAEC,KAAK,CAAC,IAAIC,MAAM,CAACC,OAAO,CAACV,MAAM,CAAC,EAAE;IAClD,IAAIW,OAAO,GAAGJ,IAAI;IAClB,IAAIX,WAAW,IAAIW,IAAI,KAAKJ,UAAU,EAAE;MACtCQ,OAAO,GAAGf,WAAW;IACvB,CAAC,MAAM;MACL,OAAOQ,QAAQ,CAACQ,GAAG,CAACD,OAAO,CAAC,EAAEA,OAAO,GAAG,GAAG,GAAGA,OAAO;IACvD;IAEA,IAAIA,OAAO,KAAKJ,IAAI,EAAE;MACpB,KAAK,MAAMxB,IAAI,IAAIyB,KAAK,EAAE;QACxB3B,IAAI,CAACa,GAAG,EAAEX,IAAI,EAAEJ,UAAU,CAACgC,OAAO,CAAC,CAAC;MACtC;IACF;EACF;EAEA,KAAK,MAAM,CAACJ,IAAI,EAAEC,KAAK,CAAC,IAAIC,MAAM,CAACC,OAAO,CAACT,YAAY,CAAC,EAAE;IACxD,MAAMY,GAAG,GACN,OAAOf,aAAa,KAAK,UAAU,IAAIA,aAAa,CAACS,IAAI,CAAC,IAC3D5B,UAAU,CAAC4B,IAAI,CAAC;IAClB,KAAK,MAAMxB,IAAI,IAAIyB,KAAK,EAAE;MACxB3B,IAAI,CAACa,GAAG,EAAEX,IAAI,EAAEL,SAAS,CAACmC,GAAG,CAAC,CAAC;IACjC;EACF;EAEAd,SAAS,GAAGL,GAAG,EAAES,UAAU,EAAEW,GAAG,IAAI;IAClCZ,wBAAwB,CAACa,OAAO,CAACC,CAAC,IAAInC,IAAI,CAACa,GAAG,EAAEsB,CAAC,EAAEF,GAAG,CAACjC,IAAI,CAACa,GAAG,EAAEsB,CAAC,CAAC,CAAC,CAAC,CAAC;EACxE,CAAC,CAAC;AACJ;AAgBA,MAAMC,UAAsC,GAAGR,MAAM,CAACS,MAAM,CAAC,IAAI,CAAC;AAClE,SAASC,UAAUA,CAACZ,IAAY,EAAE;EAChC,IAAI,CAACU,UAAU,CAACV,IAAI,CAAC,EAAE;IACrB,MAAMa,MAAM,GAAGxC,OAAO,CAAC2B,IAAI,CAAC;IAC5B,IAAI,CAACa,MAAM,EAAE;MACX,MAAMX,MAAM,CAACY,MAAM,CAAC,IAAIC,cAAc,CAAC,kBAAkBf,IAAI,EAAE,CAAC,EAAE;QAChEgB,IAAI,EAAE,sBAAsB;QAC5BH,MAAM,EAAEb;MACV,CAAC,CAAC;IACJ;IAEAU,UAAU,CAACV,IAAI,CAAC,GAAG;MACjBiB,UAAU,EAAEJ,MAAM,CAACI,UAAU;MAC7BC,KAAKA,CAAC3B,aAAa,EAAEF,WAAW,EAAEC,aAAa,EAAEE,SAAS,EAAE;QAC1D,MAAML,GAAG,GAAG0B,MAAM,CAAC1B,GAAG,CAAC,CAAC;QACxBD,gBAAgB,CACdC,GAAG,EACH0B,MAAM,CAACzB,QAAQ,EACfC,WAAW,EACXC,aAAa,EACbC,aAAa,EACbC,SACF,CAAC;QAED,OAAO;UACL2B,KAAK,EAAEhC,GAAG,CAACiC,IAAI;UACfC,OAAO,EAAER,MAAM,CAACzB,QAAQ,CAACiC;QAC3B,CAAC;MACH,CAAC;MACDC,eAAeA,CAAA,EAAG;QAChB,OAAOpB,MAAM,CAACqB,IAAI,CAACV,MAAM,CAACzB,QAAQ,CAACM,YAAY,CAAC;MAClD;IACF,CAAC;EACH;EAEA,OAAOgB,UAAU,CAACV,IAAI,CAAC;AACzB;AAEA,OAAO,SAASwB,GAAGA,CACjBxB,IAAY,EACZT,aAA6B,EAC7BF,WAAoB,EACpBC,aAAwB,EACxBE,SAAqB,EACrB;EAAA;EAYA,OAAOoB,UAAU,CAACZ,IAAI,CAAC,CAACkB,KAAK,CAC3B3B,aAAa,EACbF,WAAW,EACXC,aAAa,EACbE,SACF,CAAC;AACH;AAEA,OAAO,SAASyB,UAAUA,CAACjB,IAAY,EAAE;EACvC,OAAOY,UAAU,CAACZ,IAAI,CAAC,CAACiB,UAAU;AACpC;AAEA,OAAO,SAASK,eAAeA,CAACtB,IAAY,EAAyB;EACnE,OAAOY,UAAU,CAACZ,IAAI,CAAC,CAACsB,eAAe,CAAC,CAAC;AAC3C;AAAC;AASD,OAAO,MAAMG,IAAI,GAAGvB,MAAM,CAACqB,IAAI,CAAClD,OAAO,CAAC,CAACkC,GAAG,CAACP,IAAI,IAAIA,IAAI,CAAC0B,OAAO,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC;AAE5E,eAAeF,GAAG","ignoreList":[]}